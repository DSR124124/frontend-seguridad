<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '700px' }"
  [draggable]="false"
  [resizable]="false"
  [header]="modoEdicion ? 'Editar Conductor' : 'Crear Nuevo Conductor'"
  (onHide)="hideDialog()"
>
  <form [formGroup]="conductorForm" (ngSubmit)="guardar()">
    <div class="form-two-columns">
      <!-- Columna Izquierda -->
      <div class="form-column">
        <p-tag value="Información del Conductor" icon="pi pi-user" styleClass="tag-primary-light tag-lg" class="mb-1 w-100" />

        <!-- Usuario (Conductor) -->
        <label class="field-label required">
          <i class="pi pi-user icon-bg-primary icon-bg"></i>
          Usuario Conductor
        </label>
        <p-select
          id="idUsuarioGestion"
          formControlName="idUsuarioGestion"
          [options]="usuariosDisponibles"
          optionLabel="username"
          optionValue="idUsuario"
          placeholder="Seleccione un usuario conductor"
          [class.ng-invalid]="isFieldInvalid('idUsuarioGestion')"
          [disabled]="modoEdicion"
          [filter]="true"
          filterBy="nombreCompleto,username,email"
          [showClear]="!modoEdicion"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          (onChange)="onFieldChange('idUsuarioGestion')"
        >
          <ng-template let-usuario pTemplate="item">
            <div class="flex align-items-center">
              <div>
                <div>{{ usuario.nombreCompleto || usuario.username }}</div>
                <small class="text-secondary">{{ usuario.email }} - {{ usuario.nombreRol }}</small>
              </div>
            </div>
          </ng-template>
          <ng-template let-usuario pTemplate="selectedItem">
            <div>
              <div>{{ usuario.nombreCompleto || usuario.username }}</div>
              <small class="text-secondary">{{ usuario.email }}</small>
            </div>
          </ng-template>
        </p-select>
        <div class="field-helper error" *ngIf="isFieldInvalid('idUsuarioGestion')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['idUsuarioGestion'].errors?.['required']">El usuario conductor es requerido</span>
        </div>

        <!-- Número de Licencia -->
        <label class="field-label required">
          <i class="pi pi-id-card icon-bg-primary icon-bg"></i>
          Número de Licencia
        </label>
        <input
          id="licenciaNumero"
          type="text"
          pInputText
          formControlName="licenciaNumero"
          [class.ng-invalid]="isFieldInvalid('licenciaNumero')"
          placeholder="Ej: ABC123456"
          maxlength="20"
          class="form-control w-100 mb-1"
          (input)="onFieldChange('licenciaNumero')"
        />
        <div class="field-helper error" *ngIf="isFieldInvalid('licenciaNumero')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['licenciaNumero'].errors?.['required']">El número de licencia es requerido</span>
          <span *ngIf="f['licenciaNumero'].errors?.['maxlength']">El número de licencia no puede exceder 20 caracteres</span>
        </div>

        <!-- Categoría -->
        <label class="field-label">
          <i class="pi pi-bookmark icon-bg-primary icon-bg"></i>
          Categoría
        </label>
        <p-select
          id="categoria"
          formControlName="categoria"
          [options]="categorias"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione una categoría"
          [showClear]="true"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          (onChange)="onFieldChange('categoria')"
        ></p-select>
      </div>

      <!-- Columna Derecha -->
      <div class="form-column">
        <p-tag value="Contacto y Estado" icon="pi pi-phone" styleClass="tag-primary-light tag-lg" class="mb-1 w-100" />

        <!-- Teléfono de Contacto -->
        <label class="field-label">
          <i class="pi pi-phone icon-bg-primary icon-bg"></i>
          Teléfono de Contacto
        </label>
        <input
          id="telefonoContacto"
          type="text"
          pInputText
          formControlName="telefonoContacto"
          [class.ng-invalid]="isFieldInvalid('telefonoContacto')"
          placeholder="Ej: +504 9999-9999"
          maxlength="20"
          class="form-control w-100 mb-1"
          (input)="onFieldChange('telefonoContacto')"
        />
        <div class="field-helper error" *ngIf="isFieldInvalid('telefonoContacto')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['telefonoContacto'].errors?.['maxlength']">El teléfono no puede exceder 20 caracteres</span>
        </div>

        <!-- Estado -->
        <label class="field-label">
          <i class="pi pi-power-off icon-bg-primary icon-bg"></i>
          Estado
        </label>
        <p-select
          id="estado"
          formControlName="estado"
          [options]="estados"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione un estado"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          (onChange)="onFieldChange('estado')"
        ></p-select>
      </div>
    </div>
  </form>

  <!-- Footer con botones -->
  <p-toolbar>
    <ng-template #start></ng-template>
    <ng-template #end>
      <div class="d-flex gap-2">
        <p-button label="Cancelar" icon="pi pi-times" (onClick)="hideDialog()" styleClass="btn-danger btn-md" />
        <p-button
          [label]="modoEdicion ? 'Actualizar' : 'Guardar'"
          [icon]="modoEdicion ? 'pi pi-check' : 'pi pi-plus'"
          (onClick)="guardar()"
          [styleClass]="modoEdicion ? 'btn-info btn-md' : 'btn-success btn-md'"
          [disabled]="conductorForm.invalid"
          [loading]="loading"
        />
      </div>
    </ng-template>
  </p-toolbar>
</p-dialog>

