<div class="data-table-wrapper">
  <!-- Toolbar -->
  <div class="table-toolbar p-3" *ngIf="editable && data.length > 0">
    <div class="toolbar-info" style="gap: 0.75rem;">
      <p-tag class="row-count" styleClass="tag-md tag-gray-light">
        <i class="pi pi-list"></i>
        {{ data.length }} fila(s)
      </p-tag>
      <p-tag class="file-name-tag" *ngIf="fileName" styleClass="tag-md tag-primary-light">
        <i class="pi pi-file-excel"></i>
        <span class="file-name-text">{{ fileName }}</span>
        <button class="clear-file-btn" (click)="onClearFile()" pTooltip="Eliminar archivo y cargar uno nuevo" tooltipPosition="top">
          <i class="pi pi-times"></i>
        </button>
      </p-tag>
      <p-tag class="error-count" *ngIf="errors.length > 0" styleClass="tag-md tag-danger-light">
        <i class="pi pi-exclamation-triangle"></i>
        {{ errors.length }} error(es)
      </p-tag>
    </div>

      <p-button
        styleClass="btn-secondary btn-md"
        icon="pi pi-plus"
        label="Agregar fila"
        [outlined]="true"
        (onClick)="addRow()"
        [disabled]="data.length >= maxRows"
      ></p-button>

  </div>

  <!-- Tabla -->
  <div class="table-container p-2">
    <p-table
      [value]="data"
      [columns]="tableCols"
      [scrollable]="true"
      scrollHeight="380px"
      styleClass="tabla-datos"
      [rowHover]="true"
    >
      <ng-template pTemplate="header">
        <tr>
          <th *ngIf="showRowNumbers" class="row-number-header">#</th>
          <th
            *ngFor="let col of tableCols"
            [style.width.px]="col.width"
            [pTooltip]="col.description"
            tooltipPosition="top"
          >
            {{ col.header }}
            <span class="required-mark" *ngIf="col.required">*</span>
          </th>
          <th *ngIf="showActions && editable" class="actions-header">
            Acciones
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
        <tr [class.row-error]="row._hasError">
          <!-- Número de fila -->
          <td *ngIf="showRowNumbers" class="row-number">
            {{ rowIndex + 1 }}
          </td>

          <!-- Celdas editables -->
          <td *ngFor="let col of columns; let colIndex = index">
            <div
              class="cell-content"
              [class.cell-error]="hasError(rowIndex, col.key)"
            >
              <!-- Input de texto -->
              <div
                *ngIf="
                  col.dataType === ColumnDataType.TEXT ||
                  col.dataType === ColumnDataType.EMAIL ||
                  col.dataType === ColumnDataType.PHONE
                "
                style="position: relative; width: 100%;"
              >
                <input
                  pInputText
                  [(ngModel)]="row[col.key]"
                  [type]="getInputType(col.dataType)"
                  [attr.data-row]="rowIndex"
                  [attr.data-col]="colIndex"
                  [disabled]="!editable"
                  (input)="onCellChange(rowIndex, col)"
                  (blur)="onCellBlur(rowIndex, col)"
                  (keydown)="onKeyDown($event, rowIndex, colIndex)"
                  class="cell-input"
                  [class.ng-invalid]="hasError(rowIndex, col.key)"
                  [style.padding-right]="hasError(rowIndex, col.key) ? '32px' : '12px'"
                />
                <div
                  class="error-indicator"
                  *ngIf="hasError(rowIndex, col.key)"
                  [pTooltip]="getError(rowIndex, col.key) || ''"
                  tooltipPosition="top"
                >
                  <i class="pi pi-exclamation-circle"></i>
                </div>
              </div>

              <!-- Input numérico -->
              <div
                *ngIf="col.dataType === ColumnDataType.NUMBER"
                style="position: relative; width: 100%;"
              >
                <p-inputNumber
                  [(ngModel)]="row[col.key]"
                  [attr.data-row]="rowIndex"
                  [attr.data-col]="colIndex"
                  [disabled]="!editable"
                  (onInput)="onCellChange(rowIndex, col)"
                  (onBlur)="onCellBlur(rowIndex, col)"
                  (onKeyDown)="onKeyDown($event, rowIndex, colIndex)"
                  [inputStyleClass]="
                    hasError(rowIndex, col.key) ? 'ng-invalid' : ''
                  "
                  [inputStyle]="hasError(rowIndex, col.key) ? {'padding-right': '32px'} : {}"
                  styleClass="cell-input"
                  mode="decimal"
                  [useGrouping]="false"
                  [minFractionDigits]="col.key === 'cotizacion' ? 0 : 0"
                  [maxFractionDigits]="col.key === 'cotizacion' ? 0 : 4"
                  [maxlength]="col.key === 'cotizacion' ? 6 : null"
                ></p-inputNumber>
                <div
                  class="error-indicator"
                  *ngIf="hasError(rowIndex, col.key)"
                  [pTooltip]="getError(rowIndex, col.key) || ''"
                  tooltipPosition="top"
                >
                  <i class="pi pi-exclamation-circle"></i>
                </div>
              </div>

              <!-- Input fecha -->
              <div
                *ngIf="col.dataType === ColumnDataType.DATE"
                style="position: relative; width: 100%;"
              >
                <p-datePicker
                  [(ngModel)]="row[col.key]"
                  [attr.data-row]="rowIndex"
                  [attr.data-col]="colIndex"
                  [disabled]="!editable"
                  (onSelect)="onCellChange(rowIndex, col)"
                  (onBlur)="onCellBlur(rowIndex, col)"
                  (onKeyDown)="onKeyDown($event, rowIndex, colIndex)"
                  [inputStyleClass]="
                    hasError(rowIndex, col.key) ? 'ng-invalid' : ''
                  "
                  [inputStyle]="hasError(rowIndex, col.key) ? {'padding-right': '32px'} : {}"
                  styleClass="cell-input"
                  dateFormat="dd/mm/yy"
                  [showIcon]="true"
                  appendTo="body"
                ></p-datePicker>
                <div
                  class="error-indicator"
                  *ngIf="hasError(rowIndex, col.key)"
                  [pTooltip]="getError(rowIndex, col.key) || ''"
                  tooltipPosition="top"
                >
                  <i class="pi pi-exclamation-circle"></i>
                </div>
              </div>

              <!-- Checkbox -->
              <ng-container *ngIf="col.dataType === ColumnDataType.BOOLEAN">
                <p-checkbox
                  [(ngModel)]="row[col.key]"
                  [binary]="true"
                  [disabled]="!editable"
                  (onChange)="onCellChange(rowIndex, col)"
                ></p-checkbox>
                <div
                  class="error-indicator"
                  *ngIf="hasError(rowIndex, col.key)"
                  [pTooltip]="getError(rowIndex, col.key) || ''"
                  tooltipPosition="top"
                >
                  <i class="pi pi-exclamation-circle"></i>
                </div>
              </ng-container>
            </div>
          </td>

          <!-- Acciones -->
          <td *ngIf="showActions && editable" class="row-actions">
            <p-button
              icon="pi pi-trash"
              [rounded]="true"
              [text]="true"
              severity="danger"
              size="small"
              (onClick)="removeRow(rowIndex)"
              pTooltip="Eliminar fila"
              tooltipPosition="left"
            ></p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td
            [attr.colspan]="
              tableCols.length +
              (showRowNumbers ? 1 : 0) +
              (showActions && editable ? 1 : 0)
            "
          >
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <p>Haz clic para comenzar el ingreso manual</p>
              <p-button
                *ngIf="editable"
                styleClass="btn-primary"
                icon="pi pi-plus"
                label="Agregar primera fila"
                (onClick)="addRow()"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Panel de errores -->
  <div class="errors-panel" *ngIf="errors.length > 0">
    <div class="errors-header">
      <i class="pi pi-exclamation-triangle"></i>
      <span>{{ errors.length }} error(es) de validación</span>
    </div>
    <div class="errors-list">
      <div class="error-item" *ngFor="let error of errors.slice(0, 5)">
        <span class="error-location"
          >Fila {{ error.row + 1 }}, {{ error.column }}</span
        >
        <span class="error-message">{{ error.message }}</span>
      </div>
      <div class="error-more" *ngIf="errors.length > 5">
        ... y {{ errors.length - 5 }} error(es) más
      </div>
    </div>
  </div>
</div>
